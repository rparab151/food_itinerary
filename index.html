<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Food Itinerary Builder</title>
  <meta name="description" content="Build a â‰¤3 hour food outing itinerary (Upscale + Cheap) with Cab vs Local, live Places discovery, favorites, and sharing." />
  <style>
  :root{
    /* Apple-ish neutrals + Robinhood-ish green accent */
    --bg0:#050608;
    --bg1:#0a0b0e;

    --card: rgba(255,255,255,.06);
    --card2: rgba(255,255,255,.04);

    --text:#f7f8fb;
    --muted: rgba(247,248,251,.70);

    --border: rgba(255,255,255,.10);
    --shadow: 0 18px 60px rgba(0,0,0,.45);
    --ring: rgba(255,255,255,.22);

    --goodBg: rgba(34,197,94,.16);
    --goodBd: rgba(34,197,94,.30);

    --badBg: rgba(239,68,68,.14);
    --badBd: rgba(239,68,68,.26);

    --warnBg: rgba(245,158,11,.14);
    --warnBd: rgba(245,158,11,.26);

    --accent: rgba(34,197,94,.18);
    --accentBd: rgba(34,197,94,.34);

    --chip: rgba(255,255,255,.07);
    --chipBd: rgba(255,255,255,.12);

    --radius: 18px;
    --radius2: 22px;

    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text",
            Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  }

  [data-theme="light"]{
    --bg0:#f5f6f8;
    --bg1:#ffffff;

    --card: rgba(0,0,0,.035);
    --card2: rgba(0,0,0,.025);

    --text:#0b1220;
    --muted: rgba(11,18,32,.62);

    --border: rgba(0,0,0,.08);
    --shadow: 0 18px 55px rgba(0,0,0,.10);
    --ring: rgba(0,0,0,.18);

    --chip: rgba(0,0,0,.05);
    --chipBd: rgba(0,0,0,.10);

    --goodBg: rgba(34,197,94,.12);
    --goodBd: rgba(34,197,94,.22);

    --badBg: rgba(239,68,68,.10);
    --badBd: rgba(239,68,68,.18);

    --warnBg: rgba(245,158,11,.12);
    --warnBd: rgba(245,158,11,.20);

    --accent: rgba(34,197,94,.10);
    --accentBd: rgba(34,197,94,.22);
  }

  *{box-sizing:border-box}
  html,body{height:100%}

  body{
    margin:0;
    font-family:var(--sans);
    color:var(--text);

    /* Cleaner, â€œAppleâ€ background with subtle depth */
    background:
      radial-gradient(1200px 700px at 20% -10%, rgba(34,197,94,.12), transparent 55%),
      radial-gradient(900px 600px at 85% 0%, rgba(59,130,246,.10), transparent 55%),
      radial-gradient(900px 520px at 50% 120%, rgba(244,114,182,.08), transparent 60%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
  }

  .wrap{max-width:1120px;margin:0 auto;padding:18px 18px 28px}

  /* Header becomes more â€œproductâ€ */
  .top{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:14px;
    padding:14px 0 18px;
  }

  .title h1{
    margin:0;
    font-size:28px;
    letter-spacing:-.6px;
    line-height:1.08;
    font-weight:900;
  }
  .subtitle{
    margin-top:10px;
    color:var(--muted);
    font-size:13.5px;
    line-height:1.45;
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }

  .actions{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
    justify-content:flex-end;
  }

  .btn{
    border:1px solid var(--border);
    background: rgba(255,255,255,.045);
    color:var(--text);
    padding:10px 12px;
    border-radius:999px; /* pill */
    cursor:pointer;
    transition: transform .08s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease;
    user-select:none;
    font-weight:750;
    font-size:13px;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    gap:8px;
    box-shadow: 0 10px 28px rgba(0,0,0,.18);
  }
  .btn:hover{
    background: rgba(255,255,255,.07);
    border-color: var(--ring);
    box-shadow: 0 14px 34px rgba(0,0,0,.22);
  }
  .btn:active{transform:translateY(1px)}
  .btn.primary{
    background: linear-gradient(180deg, rgba(34,197,94,.32), rgba(34,197,94,.14));
    border-color: var(--accentBd);
  }
  .btn.small{padding:7px 10px;font-size:12px}
  .btn.ghost{background: rgba(255,255,255,.035)}

  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:980px){.grid{grid-template-columns:420px 1fr;align-items:start}}

  .card{
    background: linear-gradient(180deg, var(--card), var(--card2));
    border:1px solid var(--border);
    border-radius: var(--radius2);
    padding:14px;
    box-shadow: var(--shadow);
    backdrop-filter: blur(14px);
  }

  .cardHead{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
  .cardTitle{font-weight:900;font-size:15px;letter-spacing:-.25px}
  .cardSub{margin-top:5px;color:var(--muted);font-size:13px;line-height:1.45}

  .controls{display:grid;gap:12px;margin-top:12px}

  label{
    display:block;
    color:var(--muted);
    font-size:12px;
    margin-bottom:6px;
    font-weight:750;
    letter-spacing:.2px;
    text-transform:uppercase;
  }

  select,input{
    width:100%;
    padding:12px 12px;
    border-radius: 16px;
    border:1px solid var(--border);
    background: rgba(255,255,255,.05);
    color:var(--text);
    outline:none;
    transition:border-color .18s ease, background .18s ease, box-shadow .18s ease;
    font-size:14px;
  }
  select:focus,input:focus{
    border-color: var(--ring);
    background: rgba(255,255,255,.075);
    box-shadow: 0 0 0 6px rgba(34,197,94,.10);
  }

  .segmented{
    display:flex;
    gap:8px;
    background: rgba(255,255,255,.035);
    border:1px solid var(--border);
    padding:6px;
    border-radius: 18px;
  }

  .seg{
    flex:1;
    padding:10px 10px;
    border-radius: 14px;
    border:1px solid transparent;
    background: transparent;
    color:var(--text);
    cursor:pointer;
    font-weight:850;
    font-size:13px;
    transition: background .18s ease, border-color .18s ease, transform .08s ease;
  }
  .seg.on{
    background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
    border-color: var(--ring);
  }
  .seg:active{transform:translateY(1px)}

  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

  .chip{
    display:inline-flex;align-items:center;gap:8px;
    padding:7px 10px;border-radius:999px;
    border:1px solid var(--chipBd);
    background: var(--chip);
    font-size:12px;font-weight:750;white-space:nowrap;
  }
  .chip.good{background:var(--goodBg);border-color:var(--goodBd)}
  .chip.bad{background:var(--badBg);border-color:var(--badBd)}
  .chip.warn{background:var(--warnBg);border-color:var(--warnBd)}

  .dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.35);border:1px solid rgba(255,255,255,.18)}
  [data-theme="light"] .dot{background:rgba(0,0,0,.28);border-color:rgba(0,0,0,.18)}

  .stack{display:flex;flex-direction:column;gap:14px}
  .split{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap;margin-top:10px}

  .kpi{
    display:flex;flex-direction:column;gap:6px;
    padding:12px 12px;border-radius: var(--radius);
    border:1px solid var(--border);
    background: rgba(255,255,255,.035);
    min-width:160px; flex:1;
  }
  .kpi .k{color:var(--muted);font-size:12px;font-weight:750}
  .kpi .v{font-size:16px;font-weight:950;letter-spacing:-.25px}
  .kpi .s{color:var(--muted);font-size:12px}

  .progress{
    margin-top:12px;
    height:10px;
    border-radius:999px;
    background: rgba(255,255,255,.10);
    border:1px solid var(--border);
    overflow:hidden
  }
  .bar{
    height:100%;
    width:0%;
    background: linear-gradient(90deg, rgba(34,197,94,.75), rgba(59,130,246,.70));
  }

  .sectionTitle{
    margin-top:14px;
    font-weight:900;
    font-size:12px;
    letter-spacing:.22em;
    text-transform:uppercase;
    color:var(--muted);
  }
  .small{font-size:12px;color:var(--muted)}
  .tip{margin-top:8px;color:var(--muted);font-size:13px;line-height:1.45}

  .warn{margin-top:12px;padding:11px 12px;border-radius:var(--radius);border:1px solid var(--badBd);background:var(--badBg);font-size:13px;line-height:1.35}

  .timeline{display:grid;gap:8px;margin-top:10px}
  .trow{
    display:grid;
    grid-template-columns:70px 12px 1fr;
    gap:10px;
    align-items:center;
    padding:10px 12px;
    border-radius: var(--radius);
    border:1px solid var(--border);
    background: rgba(255,255,255,.03);
  }
  .tt{font-family:var(--mono);font-size:12.5px;color:var(--muted)}
  .tl{font-size:14px;font-weight:750}

  details.alt{margin-top:12px;border-radius: var(--radius);border:1px solid var(--border);background: rgba(255,255,255,.03);overflow:hidden}
  summary.altSum{list-style:none;cursor:pointer;user-select:none;padding:10px 12px;display:flex;align-items:center;justify-content:space-between;gap:10px;font-weight:900;font-size:13px}
  summary.altSum::-webkit-details-marker{display:none}
  .altBody{padding:10px 12px;border-top:1px solid var(--border)}
  .altCard{
    padding:10px 10px;
    border-radius: 18px;
    border:1px solid var(--border);
    background: rgba(255,255,255,.03);
    margin-bottom:10px;
    display:flex;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .altCard:last-child{margin-bottom:0}
  .altName{font-weight:950;letter-spacing:-.25px}
  .altSub{margin-top:4px;color:var(--muted);font-size:12.5px}
  .altMeta{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center}

  .list{display:grid;gap:10px;margin-top:12px}
  .li{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;padding:12px 12px;border-radius:var(--radius);border:1px solid var(--border);background:rgba(255,255,255,.04)}
  .li .name{font-weight:950;letter-spacing:-.25px}
  .li .sub{color:var(--muted);font-size:13px;margin-top:4px}
  .li .meta{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center}

  .toggle{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:10px 12px;
    border-radius: 18px;
    border:1px solid var(--border);
    background: rgba(255,255,255,.03);
  }
  .toggle .tTitle{font-weight:900;font-size:13px}

  .switch{position:relative;width:44px;height:26px;flex:0 0 auto}
  .switch input{opacity:0;width:0;height:0}
  .slider{
    position:absolute;inset:0;border-radius:999px;
    background: rgba(255,255,255,.18);
    border:1px solid var(--border);
    transition:.18s ease;
  }
  .slider:before{
    content:"";
    position:absolute;height:20px;width:20px;left:3px;top:50%;
    transform: translateY(-50%);
    background: rgba(255,255,255,.92);
    border-radius:999px;
    transition:.18s ease;
    box-shadow: 0 8px 18px rgba(0,0,0,.28);
  }
  .switch input:checked + .slider{
    background: rgba(34,197,94,.28);
    border-color: var(--accentBd);
  }
  .switch input:checked + .slider:before{ transform: translate(18px, -50%); }

  .mapShell{margin-top:10px;border-radius: var(--radius);border:1px solid var(--border);background: rgba(255,255,255,.03);overflow:hidden}
  #homeMap{width:100%;height:190px}
  .placeMap{width:100%;height:170px}
  .mapPlaceholder{padding:10px 12px;font-size:12px;color:var(--muted)}

  /* ---- Cuisine UI polish (search + chips) ---- */
  .cuiTop{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .cuiSearch{flex:1; min-width: 180px; border-radius:999px !important; padding:10px 12px !important}
  .cuiBtns{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .cuiChips{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
  .cuiChip{
    display:inline-flex; align-items:center; gap:8px;
    padding:7px 10px; border-radius:999px;
    border:1px solid var(--chipBd); background: var(--chip);
    font-size:12px; font-weight:900; cursor:pointer;
  }
  .cuiChip .x{
    opacity:.85;
    font-weight:950;
    border:1px solid var(--border);
    width:18px;height:18px;border-radius:999px;
    display:inline-flex;align-items:center;justify-content:center;
    background: rgba(255,255,255,.04);
  }
  .cuiHint{margin-top:8px}

  /* ---- Cuisine dropdown ---- */
  details.cuiDrop{
    margin-top:6px;
    border:1px solid var(--border);
    background: rgba(255,255,255,.03);
    border-radius: 18px;
    overflow:hidden;
  }
  summary.cuiDropSum{
    list-style:none;
    cursor:pointer;
    user-select:none;
    padding:10px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    font-weight:950;
    font-size:13px;
  }
  summary.cuiDropSum::-webkit-details-marker{display:none}
  .cuiDropBody{padding:10px 12px; border-top:1px solid var(--border)}

  /* ---- Settings sections (collapsible) ---- */
  details.sSection{
    border:1px solid var(--border);
    background: rgba(255,255,255,.03);
    border-radius: 18px;
    overflow:hidden;
  }
  summary.sSum{
    list-style:none;
    cursor:pointer;
    user-select:none;
    padding:10px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    font-weight:950;
    font-size:13px;
  }
  summary.sSum::-webkit-details-marker{display:none}
  .sBody{padding:10px 12px; border-top:1px solid var(--border); display:grid; gap:12px}

  /* Animated dropdown (Cuisine + Settings sections) */
  details.dropAnim > .animBody{
    display:grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows .22s ease;
  }
  details.dropAnim[open] > .animBody{
    grid-template-rows: 1fr;
  }
  details.dropAnim > .animBody > .animInner{
    overflow:hidden;
    opacity:0;
    transform: translateY(-4px);
    transition: opacity .18s ease, transform .18s ease;
  }
  details.dropAnim[open] > .animBody > .animInner{
    opacity:1;
    transform: translateY(0);
  }
</style>
</head>

<body>
  <div class="wrap" id="app" data-theme="dark">
    <header class="top">
      <div class="title">
        <h1>Food Itinerary Builder</h1>
        <div class="subtitle">
          <span class="chip"><span class="dot"></span>Home: <b id="homeLabelDisplay"></b></span>
          <span class="chip"><span class="dot"></span><b id="constraintLabel">â‰¤ 3 hours outside</b></span>
          <span class="chip"><span class="dot"></span>Cab/Local â€¢ Upscale/Cheap</span>
        </div>
      </div>
      <div class="actions">
        <button id="themeBtn" class="btn" type="button" title="Toggle theme">ðŸŒ™ Dark</button>
        <button id="resetBtn" class="btn primary" type="button" title="Reset settings">Reset</button>
      </div>
    </header>

    <div class="grid">
      <!-- Settings -->
      <div class="card">
        <div class="cardHead">
          <div>
            <div class="cardTitle">Settings</div>
            <div class="cardSub">.</div>
          </div>
        </div>

        <div class="controls">
          <details class="sSection dropAnim" open>
            <summary class="sSum"><span>Location</span><span class="badge">Home</span></summary>
            <div class="animBody"><div class="animInner"><div class="sBody">
              <div>
            <label>Home address</label>
            <input id="homeAddress" placeholder="Start typing your address..." autocomplete="off" />
            <div class="row" style="margin-top:6px; gap:8px">
              <button id="useCurrentLocation" class="btn small" type="button">Use my current location</button>
              <span id="locationStatus" class="small"></span>
            </div>
            <div class="small">Google Places Autocomplete.</div>
            <div class="mapShell">
              <div id="homeMap"><div class="mapPlaceholder">Select an address or use your current location to see it on the map.</div></div>
            </div></div></div>
          </details>

          <details class="sSection dropAnim" open>
            <summary class="sSum"><span>Plan</span><span class="badge">Meal + cuisines</span></summary>
            <div class="animBody"><div class="animInner"><div class="sBody">
              <div>
            <label>Outing type</label>
            <select id="outingKey"></select>
          </div>

          <div>
            <label>Cuisines</label>

            <details class="cuiDrop dropAnim" open>
              <summary class="cuiDropSum">
                <span>Cuisines</span>
                <span class="badge" id="cuisineCountBadge">All</span>
              </summary>

              <div class="animBody"><div class="animInner"><div class="cuiDropBody">
                <div class="cuiTop">
                  <input id="cuisineSearch" class="cuiSearch" placeholder="Search cuisinesâ€¦ (e.g., South Indian, Malvani)" />
                  <div class="cuiBtns">
                    <button id="cuisineClear" class="btn small ghost" type="button">Clear</button>
                    <button id="cuisineSelectAllShown" class="btn small ghost" type="button">Select all shown</button>
                  </div>
                </div>
              <div>
            <label>Cuisines</label>

            <details class="cuiDrop dropAnim" open>
              <summary class="cuiDropSum">
                <span>Cuisines</span>
                <span class="badge" id="cuisineCountBadge">All</span>
              </summary>

              <div class="animBody"><div class="animInner"><div class="cuiDropBody">
                <div class="cuiTop">
                  <input id="cuisineSearch" class="cuiSearch" placeholder="Search cuisinesâ€¦ (e.g., South Indian, Malvani)" />
                  <div class="cuiBtns">
                    <button id="cuisineClear" class="btn small ghost" type="button">Clear</button>
                    <button id="cuisineSelectAllShown" class="btn small ghost" type="button">Select all shown</button>
                  </div>
                </div>
            </div></div></div>
          </details>

          <details class="sSection dropAnim">
            <summary class="sSum"><span>Timing</span><span class="badge">â‰¤ 3h</span></summary>
            <div class="animBody"><div class="animInner"><div class="sBody">
              
              <div>
            <label>Max outing length (hours)</label>
            <input id="maxHours" type="range" min="0" max="10" step="0.5" value="3" />
            <div class="small"><span id="maxHoursLabel">3</span> hours (0 = no limit)</div>
          </div>
            </div></div></div>
          </details>

          <details class="sSection dropAnim">
            <summary class="sSum"><span>Travel & results</span><span class="badge">Cab/Local</span></summary>
            <div class="animBody"><div class="animInner"><div class="sBody">
              <div>
            <label>Travel style</label>
            <div class="segmented" role="group" aria-label="Travel style">
              <button id="travelComfort" class="seg on" type="button">Cab</button>
              <button id="travelCheap" class="seg" type="button">Local</button>
            </div>
          </div>
              <div>
            <label>Results</label>
            <div class="toggle">
              <div>
                <div class="tTitle">Show alternatives</div>
                <div class="small">Top 3 picks per plan</div>
              </div>
            </div></div></div>
          </details>

          <div>
            <button id="searchBtn" class="btn primary" type="button" style="width:100%;">Search</button>
            <div class="small" id="searchStatus"></div>
          </div>
          
          </div>
          </div>

          <div>
            <label>Search area (optional)</label>
            <input id="searchArea" placeholder="e.g., Matunga, Dadar, Bandra..." autocomplete="off" />
            <div class="row" style="margin-top:6px; gap:8px">
              <button id="useHomeAsSearchArea" class="btn small" type="button">Use home as search area</button>
              <span id="searchAreaStatus" class="small"></span>
            </div>
            <div class="small">Discovery happens around this area. Travel time is computed from Home.</div>
          </div>

                  <label>Discovery</label>
            <div class="segmented" role="group" aria-label="Discovery mode">
              <button id="discoveryBalanced" class="seg on" type="button">Balanced (nearby + good)</button>
              <button id="discoveryNearby" class="seg" type="button">Try something nearby & famous</button>
            </div>
          </div>

          <div>
            <label>Diet</label>
            <div class="toggle">
              <div>
                <div class="tTitle">Pure veg only</div>
                <div class="small">Best-effort from name/types</div>
              </div>
              <label class="switch" aria-label="Pure veg only">
                <input id="pureVegOnly" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div>
            <label>Availability</label>
            <div class="toggle">
              <div>
                <div class="tTitle">Open now</div>
                <div class="small">Live filter</div>
              </div>
              <label class="switch" aria-label="Open now">
                <input id="openNow" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          
              <label class="switch" aria-label="Show alternatives">
                <input id="showAlts" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
          </div>
</div>
      </div>

      <!-- Results -->
      <div class="stack">
        <div id="cardA"></div>
        <div id="cardB"></div>
        <div id="placesCard"></div>
      </div>
    </div>
  </div>

<script>
  const BACKEND_BASE = "/api";

  const outingTemplates = [
    { key:"breakfast", label:"Breakfast", defaultStart:"09:30" },
    { key:"lunch", label:"Lunch", defaultStart:"13:00" },
    { key:"snack", label:"Evening Snacks", defaultStart:"17:30" },
    { key:"dinner", label:"Dinner", defaultStart:"20:00" }
  ];

  const CUISINE_GROUPS = [
    { group:"Indian", items:["Maharashtrian","Malvani","Khandeshi","Kolhapuri","Varhadi","Puneri","North Indian","Punjabi","Gujarati","Rajasthani","Bengali","Goan","Kerala","Andhra","Hyderabadi","Mughlai"] },
    { group:"South Indian", items:["South Indian","Udupi / Darshini"] },
    { group:"Chinese", items:["Chinese"] },
    { group:"Cafe / Desserts", items:["Cafe","Bakery / Desserts"] },
    { group:"Fast food", items:["Fast food","Pizza"] },
    { group:"Street food", items:["Street food"] },
    { group:"Bars", items:["Bar / Pub"] },
    { group:"Other", items:["Seafood","Multi-cuisine / Mall","Restaurant"] }
  ];

  const FIXED_CUISINES = Array.from(new Set(CUISINE_GROUPS.flatMap(g => g.items)));

  const state = {
    homeLabel: "",
    homeLocation: null,
    searchAreaLabel: "",
    searchAreaLocation: null,
    selectedCuisines: [],
    outingKey: "dinner",
    startTime: "20:00",
    bufferMins: 12,
    maxHours: 3,
    travelStyle: "comfortable",
    discoveryMode: "balanced",
    showAlts: false,
    pureVegOnly: false,
    openNow: false,
    theme: "dark",
    hasSearched: false
  };

  // Favorites persisted
  const FAV_KEY = "fi:favs:v1";
  function loadFavs(){
    try{
      const raw = localStorage.getItem(FAV_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return new Set(Array.isArray(arr) ? arr : []);
    }catch{ return new Set(); }
  }
  function saveFavs(set){
    localStorage.setItem(FAV_KEY, JSON.stringify(Array.from(set)));
  }
  let favs = loadFavs();

  // Dynamic places pool
  let backendPlaces = [];
  let lastPicked = { A:null, B:null };

  // Cache (localStorage) to reduce API calls
  const CACHE_KEY = "fi:cache:v2";
  const CACHE_TTL_MS = 6 * 60 * 60 * 1000; // 6 hours
  function loadCache(){
    try{
      const raw = localStorage.getItem(CACHE_KEY);
      const obj = raw ? JSON.parse(raw) : {};
      return (obj && typeof obj === "object") ? obj : {};
    }catch{ return {}; }
  }
  function saveCache(obj){
    try{ localStorage.setItem(CACHE_KEY, JSON.stringify(obj)); }catch{}
  }
  let cache = loadCache();

  function cacheGet(key){
    const item = cache[key];
    if(!item) return null;
    if(!item.t || !item.v) return null;
    if(Date.now() - item.t > CACHE_TTL_MS){
      delete cache[key]; saveCache(cache);
      return null;
    }
    return item.v;
  }
  function cacheSet(key, value){
    cache[key] = { t: Date.now(), v: value };
    saveCache(cache);
  }

  // ---------- Helpers ----------
  const $ = (id)=>document.getElementById(id);
  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }
  function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }
  function haptic(ms=10){ try{ if (navigator.vibrate) navigator.vibrate(ms); }catch(_){ } }
  function parseHHMM(hhmm){
    const [h,m] = String(hhmm).split(":").map(Number);
    if(!Number.isFinite(h) || !Number.isFinite(m)) return 20*60;
    return clamp(h,0,23)*60 + clamp(m,0,59);
  }
  function fmtTime(mins){
    const total = Math.round(mins);
    const h = Math.floor(total/60);
    const m = total%60;
    const pad = (x)=>String(x).padStart(2,"0");
    return `${pad(h)}:${pad(m)}`;
  }
  function fmtDuration(mins){
    const total = Math.round(mins);
    const h = Math.floor(total/60);
    const m = total%60;
    if(h<=0) return `${m}m`;
    if(m===0) return `${h}h`;
    return `${h}h ${m}m`;
  }
  function inr(n){
    const x = Math.round(Number(n)||0);
    return "â‚¹"+x.toLocaleString("en-IN");
  }
  function fmtHours(h){
    const rounded = Math.round(h * 10) / 10;
    if (Math.abs(rounded - Math.round(rounded)) < 1e-6) return String(Math.round(rounded));
    return rounded.toFixed(1);
  }
  function deg2rad(d){ return d * Math.PI / 180; }
  function distanceKmBetween(a, b){
    if(!a || !b) return 0;
    const R = 6371;
    const dLat = deg2rad(b.lat - a.lat);
    const dLng = deg2rad(b.lng - a.lng);
    const lat1 = deg2rad(a.lat);
    const lat2 = deg2rad(b.lat);
    const sinDLat = Math.sin(dLat/2);
    const sinDLng = Math.sin(dLng/2);
    const h = sinDLat*sinDLat + Math.cos(lat1)*Math.cos(lat2)*sinDLng*sinDLng;
    const c = 2 * Math.atan2(Math.sqrt(h), Math.sqrt(1-h));
    return R * c;
  }
  function timeLimitMinutes(){
    const hrs = clamp(Number(state.maxHours ?? 0), 0, 10);
    return Math.round(hrs * 60);
  }
  function hasTimeLimit(){ return timeLimitMinutes() > 0; }

  function travelMode(){ return state.travelStyle === "comfortable" ? "cab" : "local"; }

  function getTravelStats(place, mode){
    if (state.homeLocation && place.coords){
      const dKm = distanceKmBetween(state.homeLocation, place.coords);
      const baseKm = Math.max(dKm, 0.5);
      let timeMins, cost;
      if (mode === "cab"){
        const speedKmph = 15;
        timeMins = (baseKm / speedKmph) * 60;
        cost = 70 + 22 * baseKm;
      } else {
        const speedKmph = 10;
        timeMins = (baseKm / speedKmph) * 60 + 10;
        cost = 20 + 4 * baseKm;
      }
      return { time: Math.max(5, timeMins), cost: Math.max(0, cost), distKm: baseKm };
    }
    return { time:60, cost:0, distKm:0 };
  }

  function totalMinutesFor(place){
    const mode = travelMode();
    const oneWay = getTravelStats(place, mode).time ?? 60;
    return oneWay*2 + (place.avgMealMins ?? 75) + state.bufferMins;
  }

  function isBarOrPub(place){
    const types = (place.types || []).map(t=>String(t).toLowerCase());
    if(types.some(t=>t.includes("bar") || t.includes("night_club"))) return true;
    const n = String(place.name||"").toLowerCase();
    return /(bar|pub|brew|lounge)/.test(n);
  }
  function isCafe(place){
    const types = (place.types || []).map(t=>String(t).toLowerCase());
    const n = String(place.name||"").toLowerCase();
    return types.some(t=>t.includes("cafe")) || /(cafe|coffee|bakery|patisserie)/.test(n);
  }
  function isStreetFood(place){
    const n = String(place.name||"").toLowerCase();
    const v = String(place.area||"").toLowerCase();
    return /(khau|galli|chaat|vada|pav|bhel|panipuri|pani puri|dosa|idli|misal|stall|street)/.test(n+ " " + v);
  }

  function vegSignals(place){
    const n = String(place.name||"").toLowerCase();
    const v = String(place.area||"").toLowerCase();
    const s = n + " " + v;
    const pureVeg = /(pure veg|pureveg|shuddh veg|shudh veg|satvik|jain)/.test(s);
    const vegFriendly = pureVeg || /(veg|vegetarian)/.test(s);
    return { pureVeg, vegFriendly };
  }

  function udupiHint(place){
    const n = String(place.name||"").toLowerCase();
    if(/udupi|darshini|sagar|tiffin|coffee house/.test(n)) return true;
    return false;
  }

  function likelyCrowded(place){
    // Best-effort heuristic (no review calls):
    // High volume + high rating + peak meal time => likely queues.
    const rt = Number(place.userRatingsTotal || 0);
    const r = Number(place.rating || 0);
    const mins = parseHHMM(state.startTime);
    const peak = (state.outingKey === "lunch" && mins >= 12*60 && mins <= 14*60+30) ||
                 (state.outingKey === "dinner" && mins >= 19*60 && mins <= 21*60+30);
    return peak && rt >= 1500 && r >= 4.3;
  }

  function scorePlace(place){
    let s = 0;
    const reasons = [];

    // Time limit
    const total = totalMinutesFor(place);
    const limit = timeLimitMinutes();
    if(limit > 0){
      if(total > limit){ s -= 100; reasons.push("Over time limit"); }
      else { s += 12; reasons.push("Fits time limit"); }
    } else {
      s += 6; reasons.push("No time limit");
    }

    // Distance/time
    const mode = travelMode();
    const travel = getTravelStats(place, mode);
    const oneWay = travel.time ?? 60;
    s += Math.max(0, 18 - Math.round(oneWay/5));
    reasons.push(`Shorter travel (${fmtDuration(oneWay)} one-way)`);

    // Rating / popularity
    const rating = Number(place.rating || 0);
    const urt = Number(place.userRatingsTotal || 0);
    if(Number.isFinite(rating) && rating > 0){
      s += (rating - 3.5) * 6;
      reasons.push(`Good rating (${rating.toFixed(1)})`);
    }
    if(Number.isFinite(urt) && urt > 0){
      s += Math.min(6, Math.log10(urt+1) * 2);
      reasons.push(`Popular (${urt.toLocaleString("en-IN")} reviews)`);
    }

    // Meal-aware weighting
    if(state.outingKey === "breakfast"){
      if(isBarOrPub(place)){ s -= 25; reasons.push("Deprioritized (bar/pub for breakfast)"); }
      if(udupiHint(place)){ s += 10; reasons.push("Udupi/Darshini-friendly"); }
    } else if(state.outingKey === "snack"){
      if(isStreetFood(place)){ s += 10; reasons.push("Snack-friendly (street food)"); }
      if(isCafe(place)){ s += 6; reasons.push("Snack-friendly (cafÃ©)"); }
    } else if(state.outingKey === "dinner"){
      // "Ambiance" proxy: higher rating + mid/high price level
      const pl = Number(place.priceLevel ?? 2);
      s += Math.max(0, rating - 4.0) * 4;
      if(pl >= 2){ s += 2; reasons.push("Dinner-leaning (ambiance proxy)"); }
    }

    // Discovery mode: Balanced vs Nearby & Famous
    if(state.discoveryMode === "nearby"){
      s += Math.max(0, 10 - travel.distKm);
      reasons.push("Nearby & famous mode");
    }

    // Veg preferences
    const vs = vegSignals(place);
    if(state.pureVegOnly){
      if(!vs.pureVeg){ s -= 50; reasons.push("Filtered (not pure veg)"); }
      else reasons.push("Pure veg signal");
    } else {
      if(vs.vegFriendly) { s += 1; reasons.push("Veg-friendly signal"); }
    }

    return { s, reasons, travel };
  }

  function buildItinerary(place){
    const mode = travelMode();
    const stats = getTravelStats(place, mode);
    const oneWay = stats.time ?? 60;
    const costOW = stats.cost ?? 0;
    const startMins = parseHHMM(state.startTime);

    const leave = startMins;
    const arrive = leave + oneWay;
    const mealStart = arrive;
    const mealEnd = mealStart + (place.avgMealMins ?? 75);
    const departBack = mealEnd + state.bufferMins;
    const home = departBack + oneWay;

    return {
      place,
      mode,
      oneWayMins: oneWay,
      distKm: stats.distKm ?? 0,
      totalOutMins: home - leave,
      travelCostTotal: costOW*2,
      timeline: [
        { t: fmtTime(leave), label: `Leave ${state.homeLabel || "home"}` },
        { t: fmtTime(arrive), label: `Arrive: ${place.area || "destination"}` },
        { t: fmtTime(mealStart), label: `Eat: ${place.name}` },
        { t: fmtTime(mealEnd), label: "Finish meal" },
        { t: fmtTime(departBack), label: "Head back (buffer / bill / settle)" },
        { t: fmtTime(home), label: `Back to ${state.homeLabel || "home"}` }
      ]
    };
  }

  function placeIdGoogleUrl(placeId){
    if(!placeId) return "#";
    return `https://www.google.com/maps/place/?q=place_id:${encodeURIComponent(placeId)}`;
  }
  function googlePlaceUrl(place){
    if(!place) return "#";
    const name = (place.name || "restaurant").trim();
    const area = (place.area || "").trim();
    const query = `${name} ${area}`.trim();
    if(place.id){
      return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}&query_place_id=${encodeURIComponent(place.id)}`;
    }
    return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
  }
  function googleMapsSearchUrl(place){
    // Backwards-compatible alias used by some UI blocks
    return googlePlaceUrl(place);
  }
  function directionsUrlForPlace(place){
    if (!place || !place.coords) return "#";
    const dest = `${place.coords.lat},${place.coords.lng}`;
    if (state.homeLocation){
      const origin = `${state.homeLocation.lat},${state.homeLocation.lng}`;
      return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(dest)}`;
    }
    return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}`;
  }

  function chip(text, tone){
    return `<span class="chip ${tone||""}"><span class="dot"></span>${text}</span>`;
  }

  function renderAltCards(alts){
    if(!alts || alts.length === 0) return "";
    const cards = alts.map(p=>{
      const itin = buildItinerary(p);
      const limit = timeLimitMinutes();
      const within = !hasTimeLimit() || itin.totalOutMins <= limit;
      const travelHuman = itin.mode === "cab" ? "Cab" : "Local";
      const rating = p.rating ? `â­ ${Number(p.rating).toFixed(1)}` : "No rating";
      const vs = vegSignals(p);
      const vegChip = vs.pureVeg ? chip("Pure Veg","good") : (vs.vegFriendly ? chip("Veg-friendly","") : "");
      const udupi = udupiHint(p) ? chip("Udupi/Darshini","") : "";

      return `
        <div class="altCard">
          <div>
            <div class="altName">${p.name}</div>
            <div class="altSub">${(p.area||"Nearby")}${p.isOpenNow===true ? " â€¢ Open now" : ""}</div>
            <div class="row" style="margin-top:8px">
              ${chip(travelHuman)}
              ${chip(rating)}
              ${vegChip}
              ${udupi}
              ${chip(within ? "Within limit" : "Above limit", within ? "good":"bad")}
            </div>
          </div>
          <div class="altMeta">
            ${chip("Time: " + fmtDuration(itin.totalOutMins))}
            ${chip("Travel: " + inr(itin.travelCostTotal))}
            <a class="btn small ghost" href="${googleMapsSearchUrl(p)}" target="_blank" rel="noopener noreferrer">Google</a>
          </div>
        </div>
      `;
    }).join("");

    return `
      <details class="alt" open>
        <summary class="altSum">
          <span>Alternatives</span>
          <span class="small">Extra picks</span>
        </summary>
        <div class="altBody">${cards}</div>
      </details>
    `;
  }

  function whyPanel(itin, scoreMeta){
    const limit = timeLimitMinutes();
    const within = !hasTimeLimit() || itin.totalOutMins <= limit;
    const pct = hasTimeLimit() ? Math.min(100, Math.round((itin.totalOutMins / limit) * 100)) : 0;
    const reasons = (scoreMeta?.reasons || []).slice(0, 7);
    const dist = scoreMeta?.travel?.distKm ?? itin.distKm ?? 0;

    return `
      <details style="margin-top:12px;border-radius:18px;border:1px solid var(--border);background:rgba(255,255,255,.03);overflow:hidden">
        <summary style="list-style:none;cursor:pointer;user-select:none;padding:10px 12px;display:flex;justify-content:space-between;gap:10px;align-items:center;font-weight:850;font-size:13px">
          <span>Why this pick?</span>
          <span class="small">${within ? "Fits your limit" : "May exceed limit"} â€¢ ${dist.toFixed(1)} km</span>
        </summary>
        <div style="padding:10px 12px;border-top:1px solid var(--border);display:grid;gap:8px">
          <div class="row">
            ${chip("Distance: " + dist.toFixed(1) + " km")}
            ${chip("Time fit: " + (hasTimeLimit() ? (pct + "% of limit") : "No limit"))}
            ${chip("Rating: " + (itin.place.rating ? Number(itin.place.rating).toFixed(1) : "n/a"))}
          </div>
          <div class="small">${reasons.length ? ("â€¢ " + reasons.join("<br/>â€¢ ")) : "Score reasons not available."}</div>
        </div>
      </details>
    `;
  }

  function shareTextForItinerary(label, itin){
    const modeHuman = itin.mode === "cab" ? "Cab" : "Local";
    const limit = timeLimitMinutes();
    const within = !hasTimeLimit() || itin.totalOutMins <= limit;
    return [
      `Food Itinerary (${label})`,
      `${itin.place.name} â€” ${itin.place.area || "Nearby"}`,
      `Mode: ${modeHuman} â€¢ Time out: ${fmtDuration(itin.totalOutMins)}${hasTimeLimit() ? (within ? " (fits limit)" : " (may exceed limit)") : ""}`,
      `Google: ${googlePlaceUrl(itin.place)}`
    ].join("\n");
  }

  async function doShare(label, itin){
    const text = shareTextForItinerary(label, itin);
    const url = location.href;
    try{
      if(navigator.share){
        await navigator.share({ title: "Food Itinerary", text, url });
        return true;
      }
    }catch{}
    try{
      await navigator.clipboard.writeText(text + "\n\n" + url);
      return true;
    }catch{}
    return false;
  }

  function renderItineraryCard(label, itinerary, foodBudget, alts, scoreMeta){
    if(!itinerary){
      return `<div class="card"><div class="cardTitle">${label}</div><div class="cardSub">No options found.</div></div>`;
    }
    const mapId = label.startsWith("A") ? "resultMapA" : "resultMapB";
    const limit = timeLimitMinutes();
    const within = !hasTimeLimit() || itinerary.totalOutMins <= limit;
    const foodChip = foodBudget === "comfortable" ? "Upscale" : "Cheap";
    const travelHuman = itinerary.mode === "cab" ? "Cab" : "Local";
    const ratingTxt = itinerary.place.rating ? `â­ ${Number(itinerary.place.rating).toFixed(1)}` : "No rating";
    const urt = Number(itinerary.place.userRatingsTotal || 0);
    const pop = urt ? `${urt.toLocaleString("en-IN")} reviews` : "â€”";
    const progressPct = hasTimeLimit() ? Math.min(100, Math.round((itinerary.totalOutMins / limit) * 100)) : 0;

    const vs = vegSignals(itinerary.place);
    const vegChip = vs.pureVeg ? chip("Pure Veg","good") : (vs.vegFriendly ? chip("Veg-friendly","") : "");
    const udupi = udupiHint(itinerary.place) ? chip("Udupi/Darshini","") : "";
    const crowd = likelyCrowded(itinerary.place) ? chip("Likely crowded at peak","warn") : "";

    const timeline = itinerary.timeline.map(x => `
      <div class="trow">
        <div class="tt">${x.t}</div>
        <div class="dot"></div>
        <div class="tl">${x.label}</div>
      </div>
    `).join("");

    const warn = (within || !hasTimeLimit()) ? "" : `<div class="badBox">
      This option may exceed your selected time limit depending on traffic.
    </div>`;

    const altsBlock = (state.showAlts && alts && alts.length) ? renderAltCards(alts) : "";
    const why = whyPanel(itinerary, scoreMeta);

    const isFav = favs.has(itinerary.place.id);
    const favBtn = `
      <button class="favBtn ${isFav ? "on" : ""}" type="button" data-fav="${itinerary.place.id}">
        ${isFav ? "â˜… Saved" : "â˜† Save"}
      </button>
    `;

    return `
      <div class="card">
        <div class="cardHead">
          <div>
            <div class="cardTitle">${label}</div>
            <div class="cardSub">${itinerary.place.name} â€¢ ${(itinerary.place.area||"Nearby")}</div>
            <div class="row" style="margin-top:10px">
              ${chip(foodChip)}
              ${chip("Travel: " + travelHuman)}
              ${chip(ratingTxt)}
              ${chip(pop)}
              ${vegChip}
              ${udupi}
              ${crowd}
              <span class="chip ${within ? "good":"bad"}"><span class="dot"></span>${
                hasTimeLimit()
                  ? (within ? `â‰¤ ${fmtHours(limit/60)} hours` : `> ${fmtHours(limit/60)} hours`)
                  : "No time limit"
              }</span>
            </div>
          </div>
          <div class="row" style="justify-content:flex-end">
            ${favBtn}
            <button class="btn small ghost" type="button" data-share="${label}">Share</button>
          </div>
        </div>

        <div class="split">
          <div class="kpi">
            <div class="k">Travel mode</div>
            <div class="v">${travelHuman}</div>
            <div class="s">One-way: ${fmtDuration(itinerary.oneWayMins)}</div>
          </div>
          <div class="kpi">
            <div class="k">Total time out</div>
            <div class="v">${fmtDuration(itinerary.totalOutMins)}</div>
            <div class="s">Buffer: ${state.bufferMins}m</div>
          </div>
          <div class="kpi">
            <div class="k">Travel cost (est.)</div>
            <div class="v">${inr(itinerary.travelCostTotal)}</div>
            <div class="s">Round trip</div>
          </div>
        </div>

        <div class="progress" aria-label="Time budget">
          <div class="bar" style="width:${progressPct}%"></div>
        </div>
        <div class="small" style="margin-top:6px">${
          hasTimeLimit()
            ? `${progressPct}% of your ${fmtHours(limit/60)}-hour limit`
            : "No time limit set"
        }</div>

        ${why}
        ${altsBlock}

        <div class="sectionTitle">Timeline</div>
        <div class="timeline">${timeline}</div>

        ${itinerary.place.coords ? `
        <div class="sectionTitle">Map</div>
        <div class="mapShell">
          <div id="${mapId}" class="placeMap"><div class="mapPlaceholder">Loading mapâ€¦</div></div>
        </div>
        <div class="row" style="margin-top:8px">
          <a class="btn small ghost" href="${googlePlaceUrl(itinerary.place)}" target="_blank" rel="noopener noreferrer">Google</a>
          <a class="btn small ghost" href="${directionsUrlForPlace(itinerary.place)}" target="_blank" rel="noopener noreferrer">Directions</a>
        </div>
        ` : ""}

        ${warn}
      </div>
    `;
  }

  function renderPlacesCard(){
    const mode = travelMode();
    const modeHuman = mode === "cab" ? "Cab" : "Local";
    const limit = timeLimitMinutes();
    let rowsData = currentPlacePool().slice();

    // filters
    if (state.selectedCuisines.length){
      rowsData = rowsData.filter(p => placeMatchesCuisine(p, state.selectedCuisines));
    }
    if (state.openNow){
      rowsData = rowsData.filter(p => p.isOpenNow === true);
    }
    if (state.pureVegOnly){
      rowsData = rowsData.filter(p => vegSignals(p).pureVeg);
    }
    if (hasTimeLimit()){
      rowsData = rowsData.filter(p => totalMinutesFor(p) <= limit);
    }

    // sort by distance
    rowsData.sort((a,b)=> (getTravelStats(a,mode).distKm||0) - (getTravelStats(b,mode).distKm||0));

    const rows = rowsData.slice(0, 20).map(p=>{
      const total = totalMinutesFor(p);
      const within = !hasTimeLimit() || total <= limit;
      const travel = getTravelStats(p, mode);
      const ratingTxt = p.rating ? `â­ ${Number(p.rating).toFixed(1)}` : "No rating";
      const vs = vegSignals(p);
      const vegChip = vs.pureVeg ? chip("Pure Veg","good") : (vs.vegFriendly ? chip("Veg-friendly","") : "");
      const udupi = udupiHint(p) ? chip("Udupi/Darshini","") : "";
      const isFav = favs.has(p.id);
      return `
        <div class="altCard">
          <div>
            <div class="altName">${p.name}</div>
            <div class="altSub">${(p.area||"Nearby")}${p.isOpenNow===true ? " â€¢ Open now" : ""}</div>
            <div class="row" style="margin-top:8px">
              ${chip(modeHuman)}
              ${chip(ratingTxt)}
              ${vegChip}
              ${udupi}
              ${chip("~" + travel.distKm.toFixed(1) + " km")}
              ${chip(within ? "Within limit" : "Above limit", within ? "good":"bad")}
            </div>
          </div>
          <div class="altMeta">
            <button class="favBtn ${isFav?"on":""}" type="button" data-fav="${p.id}">${isFav?"â˜…":"â˜†"}</button>
            <a class="btn small ghost" href="${googlePlaceUrl(p)}" target="_blank" rel="noopener noreferrer">Google</a>
          </div>
        </div>
      `;
    }).join("");

    const favCount = favs.size;
    const favHint = favCount ? ` â€¢ Favorites: ${favCount}` : "";

    return `
      <div class="card">
        <div class="cardHead">
          <div>
            <div class="cardTitle">Included places</div>
            <div class="cardSub">Live discovery around your search area (cached). Travel time is computed from Home.${favHint}</div>
          </div>
          <div class="row" style="justify-content:flex-end">
            <button id="showFavsBtn" class="btn small ghost" type="button">Show favorites</button>
          </div>
        </div>
        <div class="list">${rows || "<div class='small'>No places match the current filters.</div>"}</div>
      </div>
    `;
  }

  // Fallback pool (only if live empty)
  const placesFallback = [
    { id:"viviana-mall-thane", name:"Viviana Mall Dining", area:"Viviana Mall, Thane", coords:{ lat:19.1865, lng:72.9785 }, rating:4.2, userRatingsTotal:12000, priceLevel:2, types:["restaurant"], isOpenNow:null, avgMealMins:90 },
    { id:"kalwa-parsik-eateries", name:"Kalwa / Parsik Eateries", area:"Kalwa / Parsik Nagar", coords:{ lat:19.1869, lng:73.0220 }, rating:4.1, userRatingsTotal:4000, priceLevel:1, types:["restaurant"], isOpenNow:null, avgMealMins:60 }
  ];
  function currentPlacePool(){ return backendPlaces.length ? backendPlaces : placesFallback; }

  function pickPrimaryAndAlts(foodBudget, k=3){
    const ranked = getRanked(foodBudget);
    if(ranked.length === 0) return { primary:null, alts:[], meta:new Map() };

    const primary = ranked[0];
    const alts = ranked.slice(1, Math.max(1,k)).filter(p=>p.id!==primary.id);
    return { primary, alts };
  }

  function budgetBucket(place){
    // Map Google's price_level -> cheap vs comfortable.
    // In India, price_level is often missing; treat unknown as cheap-leaning so B doesn't go empty.
    const pl = place.priceLevel;
    if (pl === 0 || pl === 1) return "cheap";
    if (pl === 2 || pl === 3 || pl === 4) return "comfortable";
    return "cheap";
  }

  function placeMatchesCuisine(place, selected){
    // Best-effort: match on keyword tokens in name/types
    const n = String(place.name||"").toLowerCase();
    const a = String(place.area||"").toLowerCase();
    const t = (place.types||[]).map(x=>String(x).toLowerCase()).join(" ");
    const s = n + " " + a + " " + t;

    const want = selected.map(x=>String(x).toLowerCase());

    const matchOne = (c)=>{
      if(c === "south indian") return /south indian|udupi|darshini|dosa|idli|sambar/.test(s);
      if(c === "udupi / darshini") return /udupi|darshini|sagar/.test(s);
      if(c === "maharashtrian") return /maharashtrian|misal|thalipeeth|poha|vada pav|pav bhaji/.test(s);
      if(["malvani","khandeshi","kolhapuri","varhadi","puneri"].includes(c)){
        return new RegExp(c).test(s) || /kolhapuri|malvani|khandeshi|varhadi|puneri/.test(s);
      }
      if(c === "street food") return isStreetFood(place);
      if(c === "cafe") return isCafe(place);
      if(c === "bar / pub") return isBarOrPub(place);
      if(c === "pizza") return /pizza/.test(s);
      if(c === "chinese") return /chinese|noodle|schezwan/.test(s);
      if(c === "bakery / desserts") return /bakery|dessert|cake|pastry|ice cream/.test(s);
      if(c === "seafood") return /seafood|fish|prawn|bombil/.test(s);
      if(c === "fast food") return /fast food|burger|sandwich|wrap/.test(s);
      // Generic: token match
      return s.includes(c);
    };

    return want.some(matchOne);
  }

  function getRanked(foodBudget){
    const limit = timeLimitMinutes();
    const pool = currentPlacePool();

    const filtered = pool
      .filter(p => budgetBucket(p) === (foodBudget === "comfortable" ? "comfortable" : "cheap"))
      .filter(p => !state.openNow || p.isOpenNow === true)
      .filter(p => !state.pureVegOnly || vegSignals(p).pureVeg)
      .filter(p => !state.selectedCuisines.length || placeMatchesCuisine(p, state.selectedCuisines))
      .filter(p => !hasTimeLimit() || totalMinutesFor(p) <= limit);

    const scored = filtered.map(p => {
      const meta = scorePlace(p);
      return { p, s: meta.s, meta };
    }).sort((a,b)=> b.s - a.s);

    // Keep meta map for "Why this pick?"
    const metaMap = new Map(scored.map(x=>[x.p.id, x.meta]));
    return scored.map(x=>x.p).map(p=>({p, meta: metaMap.get(p.id)}));
  }

  function pickWithMeta(foodBudget, k=3){
    const ranked = getRanked(foodBudget);
    if(!ranked.length) return { primary:null, alts:[], meta:new Map() };
    const primary = ranked[0].p;
    const alts = ranked.slice(1, k).map(x=>x.p);
    const meta = new Map(ranked.map(x=>[x.p.id, x.meta]));
    return { primary, alts, meta };
  }

  // ---------- Rendering ----------
  function render(){
    const homeDisplay = $("homeLabelDisplay");
    homeDisplay.textContent = state.homeLabel || "Home";

    const hrs = clamp(Number(state.maxHours ?? 0), 0, 10);
    $("maxHoursLabel").textContent = String(hrs);
    $("constraintLabel").textContent = hrs === 0 ? "No time limit" : `â‰¤ ${hrs} hour${hrs === 1 ? "" : "s"} outside`;

    if (!state.hasSearched){
      $("cardA").innerHTML = `<div class="card"><div class="cardTitle">A) Upscale</div><div class="cardSub">Set preferences, then hit <b>Search</b>.</div></div>`;
      $("cardB").innerHTML = `<div class="card"><div class="cardTitle">B) Cheap</div><div class="cardSub">Set preferences, then hit <b>Search</b>.</div></div>`;
      $("placesCard").innerHTML = renderPlacesCard();
      wireDynamicButtons();
      return;
    }

    const a = pickWithMeta("comfortable", 3);
    const b = pickWithMeta("cheap", 3);

    const aItin = a.primary ? buildItinerary(a.primary) : null;
    const bItin = b.primary ? buildItinerary(b.primary) : null;

    lastPicked.A = aItin; lastPicked.B = bItin;

    $("cardA").innerHTML = renderItineraryCard("A) Upscale", aItin, "comfortable", a.alts, aItin ? a.meta.get(aItin.place.id) : null);
    $("cardB").innerHTML = renderItineraryCard("B) Cheap", bItin, "cheap", b.alts, bItin ? b.meta.get(bItin.place.id) : null);
    $("placesCard").innerHTML = renderPlacesCard();

    if (window.google && google.maps){
      initResultMaps(aItin, bItin);
    }
    wireDynamicButtons();
  }

  function wireDynamicButtons(){
    // Favorite buttons
    document.querySelectorAll("[data-fav]").forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute("data-fav");
        if(!id) return;
        if(favs.has(id)) favs.delete(id); else favs.add(id);
        saveFavs(favs);
        render();
      };
    });

    // Share inside A/B cards
    document.querySelectorAll("[data-share]").forEach(btn=>{
      btn.onclick = async ()=>{
        const which = btn.getAttribute("data-share") || "";
        const itin = which.startsWith("A") ? lastPicked.A : lastPicked.B;
        if(!itin) return;
        const ok = await doShare(which, itin);
        const st = $("searchStatus");
        if(st) st.textContent = ok ? "Shared (or copied to clipboard)." : "Share failed.";
        setTimeout(()=>{ if(st) st.textContent=""; }, 1800);
      };
    });

    // Show favorites list
    const favBtn = $("showFavsBtn");
    if(favBtn){
      favBtn.onclick = ()=>{
        const pool = currentPlacePool();
        const favPlaces = pool.filter(p => favs.has(p.id));
        if(!favPlaces.length){
          $("searchStatus").textContent = "No favorites yet. Tap â˜† on any place.";
          setTimeout(()=>{ $("searchStatus").textContent=""; }, 2000);
          return;
        }
        backendPlaces = favPlaces;
        state.hasSearched = false;
        render();
      };
    }
  }

  // ---------- Cuisine UI ----------
  function renderCuisineGroups(){
    const root = $("cuisineGroups");
    const chips = document.getElementById("cuisineChips");
    const qEl = document.getElementById("cuisineSearch");
    const q = (qEl && qEl.value ? qEl.value : "").trim().toLowerCase();

    // chips
    if (chips){
      const sel = state.selectedCuisines || [];
      if(!sel.length){
        chips.innerHTML = `<span class="small">No cuisine filter applied.</span>`;
      } else {
        chips.innerHTML = sel.map(c=>`
          <span class="cuiChip" data-cui="${escapeHtml(c)}" title="Remove">
            ${escapeHtml(c)} <span class="x">Ã—</span>
          </span>
        `).join("");
        chips.querySelectorAll(".cuiChip").forEach(el=>{
          el.addEventListener("click", ()=>{
            const c = el.getAttribute("data-cui") || "";
            state.selectedCuisines = (state.selectedCuisines||[]).filter(x=>x!==c);
            state.hasSearched = false;
            renderCuisineGroups();

  // Cuisine UI controls
  const cuisineSearchEl = document.getElementById("cuisineSearch");
  const cuisineClearBtn = document.getElementById("cuisineClear");
  const cuisineSelectAllShownBtn = document.getElementById("cuisineSelectAllShown");

  if (cuisineSearchEl){
    cuisineSearchEl.addEventListener("input", ()=>{
      renderCuisineGroups();
    });
  }
  if (cuisineClearBtn){
    cuisineClearBtn.addEventListener("click", ()=>{
      state.selectedCuisines = [];
    const cuisineSearchEl2 = document.getElementById("cuisineSearch");
    if (cuisineSearchEl2) cuisineSearchEl2.value = "";
      if (cuisineSearchEl) cuisineSearchEl.value = "";
      state.hasSearched = false;
      renderCuisineGroups();
      render();
    });
  }
  if (cuisineSelectAllShownBtn){
    cuisineSelectAllShownBtn.addEventListener("click", ()=>{
      const q = (cuisineSearchEl && cuisineSearchEl.value || "").trim().toLowerCase();
      const matches = (s)=> !q || String(s).toLowerCase().includes(q);
      const toAdd = CUISINE_GROUPS.flatMap(g=>g.items).filter(matches);
      state.selectedCuisines = Array.from(new Set([...(state.selectedCuisines||[]), ...toAdd]));
      state.hasSearched = false;
      renderCuisineGroups();
      render();
    });
  }
            render();
          });
        });
      }
    }

    // list
    if(!root) return;
    root.innerHTML = "";

    const matches = (s)=> !q || String(s).toLowerCase().includes(q);

    CUISINE_GROUPS.forEach(g=>{
      const filtered = g.items.filter(item => matches(item));
      if(!filtered.length) return;

      const det = document.createElement("details");
      det.className = "cGroup";
      // Open Indian by default; otherwise open when searching
      det.open = q ? true : (g.group === "Indian");

      const sum = document.createElement("summary");
      sum.className = "cSum";
      const selectedInGroup = g.items.filter(x => (state.selectedCuisines||[]).includes(x)).length;
      sum.innerHTML = `<span>${escapeHtml(g.group)}</span><span class="badge">${selectedInGroup}/${g.items.length}</span>`;

      const body = document.createElement("div");
      body.className = "cBody";

      filtered.forEach(item=>{
        const row = document.createElement("label");
        row.className = "cItem";

        const left = document.createElement("span");
        left.style.display = "inline-flex";
        left.style.alignItems = "center";
        left.style.gap = "10px";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = (state.selectedCuisines||[]).includes(item);

        cb.addEventListener("change", ()=>{
          if(cb.checked){
            if(!state.selectedCuisines.includes(item)) state.selectedCuisines.push(item);
          } else {
            state.selectedCuisines = state.selectedCuisines.filter(x=>x!==item);
          }
          state.hasSearched = false;
          renderCuisineGroups();
          render();
        });

        const span = document.createElement("span");
        span.textContent = item;

        left.appendChild(cb);
        left.appendChild(span);
        row.appendChild(left);

        body.appendChild(row);
      });

      det.appendChild(sum);
      det.appendChild(body);
      root.appendChild(det);
    });

    if(!root.children.length){
      root.innerHTML = `<div class="small">No cuisines match â€œ${escapeHtml(q)}â€.</div>`;
    }
  }

  // ---------- Google Maps rendering ----------
  const homeMapEl = document.getElementById("homeMap");
  let homeMap = null;
  let homeMapMarker = null;

  function updateHomeMap(){
    if (!homeMapEl || !window.google || !google.maps || !state.homeLocation) return;
    const center = state.homeLocation;
    if (!homeMap) {
      homeMap = new google.maps.Map(homeMapEl, { center, zoom: 14, disableDefaultUI: true, zoomControl: true });
      homeMapMarker = new google.maps.Marker({ position: center, map: homeMap });
    } else {
      homeMap.setCenter(center);
      if (homeMapMarker) homeMapMarker.setPosition(center);
      else homeMapMarker = new google.maps.Marker({ position: center, map: homeMap });
    }
  }

  function initPlaceMap(elemId, coords){
    const el = document.getElementById(elemId);
    if (!el || !window.google || !google.maps || !coords) return;
    const map = new google.maps.Map(el, { center: coords, zoom: 14, disableDefaultUI: true, zoomControl: true });
    new google.maps.Marker({ position: coords, map });
  }
  function initResultMaps(aItin, bItin){
    if (aItin?.place?.coords) initPlaceMap("resultMapA", aItin.place.coords);
    if (bItin?.place?.coords) initPlaceMap("resultMapB", bItin.place.coords);
  }

  // ---------- Live discovery ----------
  function cuisineToKeyword(selected){
    // Turn selected cuisines into a single keyword string to help Nearby Search.
    // Keep it short to reduce strange matches.
    const s = new Set(selected.map(x=>String(x).toLowerCase()));
    const kws = [];
    if(s.has("south indian")) kws.push("south indian");
    if(s.has("udupi / darshini")) kws.push("udupi darshini");
    if(s.has("maharashtrian")) kws.push("maharashtrian");
    if(["malvani","khandeshi","kolhapuri","varhadi","puneri"].some(x=>s.has(x))) kws.push("malvani kolhapuri");
    if(s.has("street food")) kws.push("street food");
    if(s.has("cafe")) kws.push("cafe");
    if(s.has("bar / pub")) kws.push("bar pub");
    if(s.has("chinese")) kws.push("chinese");
    if(s.has("pizza")) kws.push("pizza");
    if(s.has("bakery / desserts")) kws.push("bakery dessert");
    if(s.has("seafood")) kws.push("seafood fish");
    if(s.has("fast food")) kws.push("fast food");
    // meal-aware keyword hint
    if(state.outingKey === "breakfast") kws.push("breakfast");
    if(state.outingKey === "snack") kws.push("snacks");
    return kws.join(" ").trim();
  }

  function placeFromBackendResult(r){
    return {
      id: r.id,
      name: r.name || "Nearby restaurant",
      area: r.area || "Nearby",
      coords: r.coords || null,
      rating: r.rating,
      userRatingsTotal: r.userRatingsTotal,
      priceLevel: r.priceLevel,
      types: r.types || [],
      isOpenNow: r.isOpenNow,
      avgMealMins: 75
    };
  }

  async function loadDynamicPlaces(){
    const base = state.searchAreaLocation || state.homeLocation;
    if (!base || !window.fetch) { backendPlaces = []; render(); return; }

    const keyword = cuisineToKeyword(state.selectedCuisines);
    const params = new URLSearchParams({
      lat: String(base.lat),
      lng: String(base.lng),
      radiusKm: "5",
      maxResults: "20",
      openNow: state.openNow ? "1" : "0",
      keyword: keyword
    });

    const cacheKey = "places:" + params.toString();
    const hit = cacheGet(cacheKey);
    if(hit){
      backendPlaces = hit.map(placeFromBackendResult);
      $("searchStatus").textContent = "Loaded from cache.";
      setTimeout(()=>{ $("searchStatus").textContent=""; }, 1200);
      render();
      return;
    }

    $("searchStatus").textContent = "Searching live placesâ€¦";
    const resp = await fetch(`${BACKEND_BASE}/places?${params.toString()}`);
    if(!resp.ok){
      backendPlaces = [];
      $("searchStatus").textContent = "Live search failed.";
      setTimeout(()=>{ $("searchStatus").textContent=""; }, 1600);
      render();
      return;
    }
    const data = await resp.json();
    const list = Array.isArray(data.places) ? data.places : [];
    cacheSet(cacheKey, list);
    backendPlaces = list.map(placeFromBackendResult);

    // If user asked Pure Veg only, keep some slack: filter client-side, but keep cache unchanged
    if(state.pureVegOnly){
      backendPlaces = backendPlaces.filter(p => vegSignals(p).pureVeg);
    }
    $("searchStatus").textContent = `Found ${backendPlaces.length} places.`;
    setTimeout(()=>{ $("searchStatus").textContent=""; }, 1300);
    render();
  }

  // Hard debounce: Search triggers only after 500ms from last click
  let searchDebounceTimer = null;
  function debouncedSearch(){
    if(searchDebounceTimer) clearTimeout(searchDebounceTimer);
    searchDebounceTimer = setTimeout(async ()=>{
      await loadDynamicPlaces();
      state.hasSearched = true;
      render();
    }, 500);
  }

  // ---------- Address / area autocomplete ----------
  function initHomeAutocomplete(){
    const homeInput = $("homeAddress");
    const areaInput = $("searchArea");
    if(!window.google || !google.maps || !google.maps.places) return;

    // Home
    if(homeInput){
      const homeAC = new google.maps.places.Autocomplete(homeInput, { types: ["geocode"] });
      homeAC.addListener("place_changed", ()=>{
        const p = homeAC.getPlace();
        const label = (p && p.formatted_address) || homeInput.value || "Home";
        state.homeLabel = label;
        if (p?.geometry?.location){
          state.homeLocation = { lat: p.geometry.location.lat(), lng: p.geometry.location.lng() };
          updateHomeMap();
          state.hasSearched = false;
          render();
        }
      });
    }

    // Search area
    if(areaInput){
      const areaAC = new google.maps.places.Autocomplete(areaInput, { types: ["geocode"] });
      areaAC.addListener("place_changed", ()=>{
        const p = areaAC.getPlace();
        const label = (p && p.formatted_address) || areaInput.value || "";
        state.searchAreaLabel = label;
        if(p?.geometry?.location){
          state.searchAreaLocation = { lat: p.geometry.location.lat(), lng: p.geometry.location.lng() };
          $("searchAreaStatus").textContent = "Search area set.";
          setTimeout(()=>{ $("searchAreaStatus").textContent=""; }, 1200);
          state.hasSearched = false;
          render();
        }
      });
    }

    updateHomeMap();
  }

  // Use current location
  $("useCurrentLocation").addEventListener("click", ()=>{
    if (!navigator.geolocation) { $("locationStatus").textContent = "Geolocation not supported."; return; }
    $("locationStatus").textContent = "Detectingâ€¦";
    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        const { latitude, longitude } = pos.coords;
        state.homeLocation = { lat: latitude, lng: longitude };
        state.homeLabel = "Current location";
        $("homeAddress").value = "Current location";
        updateHomeMap();
        $("locationStatus").textContent = "Using current location.";
        setTimeout(()=>{ $("locationStatus").textContent=""; }, 1200);
        state.hasSearched = false;
        render();
      },
      ()=>{ $("locationStatus").textContent = "Permission denied/unavailable."; }
    );
  });

  // Use home as search area
  $("useHomeAsSearchArea").addEventListener("click", ()=>{
    if(!state.homeLocation){ $("searchAreaStatus").textContent = "Set home first."; return; }
    state.searchAreaLocation = { ...state.homeLocation };
    state.searchAreaLabel = state.homeLabel || "Home";
    $("searchArea").value = state.searchAreaLabel;
    $("searchAreaStatus").textContent = "Search area = Home.";
    setTimeout(()=>{ $("searchAreaStatus").textContent=""; }, 1200);
    state.hasSearched = false;
    render();
  });

  // ---------- Wire remaining UI ----------
  // outing select
  const outingSelect = $("outingKey");
  outingTemplates.forEach(t=>{
    const opt = document.createElement("option");
    opt.value = t.key;
    opt.textContent = t.label;
    outingSelect.appendChild(opt);
  });
  outingSelect.value = state.outingKey;
  outingSelect.addEventListener("change", (e)=>{
    state.outingKey = e.target.value;
    const t = outingTemplates.find(x=>x.key===state.outingKey);
    if(t){ state.startTime = t.defaultStart; $("startTime").value = state.startTime; }
    state.hasSearched = false;
    render();
  });

  $("startTime").addEventListener("input", (e)=>{ state.startTime = e.target.value; state.hasSearched = false; render(); });
  $("bufferMins").addEventListener("input", (e)=>{ state.bufferMins = clamp(Number(e.target.value||0), 0, 30); state.hasSearched = false; render(); });

  $("maxHours").addEventListener("input", (e)=>{ state.maxHours = Number(e.target.value || 0); state.hasSearched = false; render(); });

  function setTravelStyle(style){
    state.travelStyle = style;
    $("travelComfort").classList.toggle("on", style==="comfortable");
    $("travelCheap").classList.toggle("on", style==="cheap");
    state.hasSearched = false;
    render();
  }
  $("travelComfort").addEventListener("click", ()=>{ haptic(8); setTravelStyle("comfortable"); });
  $("travelCheap").addEventListener("click", ()=>{ haptic(8); setTravelStyle("cheap"); });

  function setDiscoveryMode(mode){
    state.discoveryMode = mode;
    $("discoveryBalanced").classList.toggle("on", mode==="balanced");
    $("discoveryNearby").classList.toggle("on", mode==="nearby");
    state.hasSearched = false;
    render();
  }
  $("discoveryBalanced").addEventListener("click", ()=>setDiscoveryMode("balanced"));
  $("discoveryNearby").addEventListener("click", ()=>setDiscoveryMode("nearby"));

  $("showAlts").addEventListener("change", (e)=>{ state.showAlts = !!e.target.checked; render(); });
  $("pureVegOnly").addEventListener("change", (e)=>{ state.pureVegOnly = !!e.target.checked; state.hasSearched = false; render(); });
  $("openNow").addEventListener("change", (e)=>{ state.openNow = !!e.target.checked; state.hasSearched = false; render(); });

  function setTheme(theme){
    state.theme = theme;
    const appEl = $("app");
    if(appEl) appEl.setAttribute("data-theme", theme);
    if(document.documentElement) document.documentElement.setAttribute("data-theme", theme);
    $("themeBtn").textContent = theme === "dark" ? "ðŸŒ™ Dark" : "â˜€ï¸ Light";
  }
  $("themeBtn").addEventListener("click", ()=> { haptic(8); setTheme(state.theme === "dark" ? "light" : "dark"); });

  $("resetBtn").addEventListener("click", ()=>{ haptic(10);
    Object.assign(state, {
      homeLabel:"", homeLocation:null,
      searchAreaLabel:"", searchAreaLocation:null,
      selectedCuisines:[], outingKey:"dinner", startTime:"20:00",
      bufferMins:12, maxHours:3, travelStyle:"comfortable",
      discoveryMode:"balanced", showAlts:false, pureVegOnly:false, openNow:false,
      hasSearched:false
    });
    backendPlaces = [];
    $("homeAddress").value = "";
    $("searchArea").value = "";
    $("startTime").value = state.startTime;
    $("bufferMins").value = state.bufferMins;
    $("maxHours").value = state.maxHours;
    $("showAlts").checked = false;
    $("pureVegOnly").checked = false;
    $("openNow").checked = false;
    outingSelect.value = state.outingKey;
    setTravelStyle(state.travelStyle);
    setDiscoveryMode(state.discoveryMode);
    renderCuisineGroups();
    render();
  });

  $("searchBtn").addEventListener("click", ()=>{
    // 500ms hard debounce
    debouncedSearch();
  });

  // Called by Google Maps JS if auth fails
  window.gm_authFailure = function(){
    const st = $("searchStatus");
    if(st) st.textContent = "Google Maps couldnâ€™t load. Check API key, billing, and allowed websites.";
  };

  window.initHomeAutocomplete = initHomeAutocomplete;

  // init
  renderCuisineGroups();
  setTheme(state.theme);
  setTravelStyle(state.travelStyle);
  setDiscoveryMode(state.discoveryMode);
  render();
</script>

<!-- IMPORTANT: Use your Google Maps *browser* key (Maps JavaScript API + Places API enabled). -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBhqJPZW22_07H7TKL41hdb9e7mQiYbXgs&libraries=places&callback=initHomeAutocomplete" async defer></script>
</body>
</html>
